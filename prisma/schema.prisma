generator client {
  provider = "prisma-client-js"
}

generator erd {
  provider = "prisma-erd-generator"
  theme = "forest"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  GUEST
  ADMIN
}

enum AuthProvider {
  EMAIL
  GOOGLE
  APPLE
}

enum EventVisibility {
  PUBLIC
  PRIVATE
  UNLISTED
}

enum EventType {
  WEDDING
  BIRTHDAY
  CORPORATE
  COLLEGE_FEST
  OTHER
}

enum GuestStatus {
  INVITED
  JOINED
  CHECKED_IN
}

enum DeviceType {
  IOS
  ANDROID
  WEB
}

model User {
  id           String       @id @default(uuid())
  firebaseUid  String       @unique
  email        String?      @unique
  name         String?
  avatarUrl    String?
  authProvider AuthProvider @default(EMAIL)
  role         UserRole     @default(GUEST)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  deletedAt    DateTime?

  devices           Device[]
  guestEvents       GuestEvent[]
  announcementsSent Announcement[] @relation("AnnouncementSender")
  eventsCreated     Event[]         @relation("EventAdmin")
  scheduleItems     ScheduleItem[]  @relation("ScheduleItemCreator")

  @@index([firebaseUid])
  @@index([email])
  @@index([deletedAt])
  @@map("users")
}

model Device {
  id        String     @id @default(uuid())
  userId    String
  fcmToken  String
  deviceType DeviceType
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  deletedAt DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, fcmToken])
  @@index([userId])
  @@index([fcmToken])
  @@index([deletedAt])
  @@map("devices")
}

model Event {
  id          String         @id @default(uuid())
  name        String
  description String?
  shortCode   String         @unique
  startDate   DateTime
  endDate     DateTime
  location    String?
  visibility  EventVisibility @default(PUBLIC)
  type        EventType      @default(OTHER)
  adminId     String
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  deletedAt   DateTime?

  admin          User            @relation("EventAdmin", fields: [adminId], references: [id], onDelete: Cascade)
  scheduleItems   ScheduleItem[]
  announcements  Announcement[]
  guestEvents    GuestEvent[]

  @@index([adminId])
  @@index([shortCode])
  @@index([startDate])
  @@index([endDate])
  @@index([visibility])
  @@index([type])
  @@index([deletedAt])
  @@map("events")
}

model ScheduleItem {
  id          String   @id @default(uuid())
  eventId     String
  title       String
  description String?
  startTime   DateTime
  endTime     DateTime
  location    String?
  orderIndex  Int      @default(0)
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?

  event     Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  creator   User  @relation("ScheduleItemCreator", fields: [createdBy], references: [id], onDelete: Restrict)

  @@index([eventId])
  @@index([startTime])
  @@index([orderIndex])
  @@index([createdBy])
  @@index([deletedAt])
  @@map("schedule_items")
}

model Announcement {
  id          String   @id @default(uuid())
  eventId     String
  senderId    String
  title       String
  message     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?

  event  Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  sender User  @relation("AnnouncementSender", fields: [senderId], references: [id], onDelete: Restrict)

  @@index([eventId])
  @@index([senderId])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("announcements")
}

model GuestEvent {
  id        String      @id @default(uuid())
  userId    String
  eventId   String
  status    GuestStatus @default(INVITED)
  joinedAt  DateTime?   @default(now())
  checkedInAt DateTime?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  deletedAt DateTime?

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([userId, eventId])
  @@index([eventId])
  @@index([userId])
  @@index([status])
  @@index([deletedAt])
  @@map("guest_events")
}

model NotificationLog {
  id          String   @id @default(uuid())
  userId      String?
  eventId     String?
  deviceId    String?
  title       String
  message     String
  fcmToken    String
  success     Boolean
  errorMessage String?
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([eventId])
  @@index([deviceId])
  @@index([success])
  @@index([createdAt])
  @@map("notification_logs")
}
